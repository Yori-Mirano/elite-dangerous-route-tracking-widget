<!DOCTYPE html>
<html>
  <head>
    <title>Elite Dangerous - Route Tracking Widget</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
      :root {
        --color-primary   : white;
        --color-secondary : #02a5ec;
        --color-off       : #666;
      }

      body {
        background-color: black;
        color: white;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        height: 100vh;
        font-family: Arial, Helvetica, sans-serif;
      }

      body::before,
      body::after {
        content: "";
        position: absolute;
        left: 0;
        background-image: linear-gradient(to right, black, transparent);
        height: 100%;
        width: 80px;
        z-index: 1;
      }

      body::after {
        left: auto;
        right: 0;
        transform: rotate(180deg);
      }
  
      ul {
        display: flex;
        margin: 0;
        padding: 0;
        list-style-type: none;
        position: relative;
        width: 0;
        transition: transform .5s;
      }
  
      li {
        display: flex;
        align-items: center;
        position: relative;
      }

      li                      { --color: var(--color-secondary); }

      li.current              { --color: var(--color-primary); }
      li.current::before      { --color: var(--color-secondary); }
      li.current ~ li         { --color: var(--color-off); }

      li.jumping              { --color: var(--color-off); }
      li.jumping::before      { --color: var(--color-primary); }
      li.jumping ~ li         { --color: var(--color-off); }
  
      li::after {
        content: "";
        box-sizing: border-box;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        border: 2px solid var(--color);
        transition-property: border-color, background-color;
        transition-duration: .5s;
      }

      li.scoopable::after {
        background-color: var(--color);
      }
  
      li + li::before {
        content: "";
        display: block;
        width: 35px;
        height: 2px;
        margin: 0 2px;
        background-color: var(--color);
        transition: background-color .5s;
      }
  
      li > span {
        position: absolute;
        right: 5px;
        transform: translate(50%, 20px);
        width: 14ch;
        font-size: 12px;
        text-align: center;
        line-height: 1;
        color: var(--color-off);
        transition: color .5s;
      }

      li.current > span {
        color: var(--color-primary);
      }
  
      li:nth-child(odd) > span {
        transform: translate(50%, -20px);
      }

      @keyframes pulse {
        from { opacity: 1; }
        to   { opacity: 0.2; }
      }

      li.jumping::before {
        animation: pulse infinite alternate .75s;
      }
    </style>
  </head>
  
  <body>
    <script>
      /**
       * Helpers
       */
      function createElement(tagName, parentEl) {
        const el = document.createElement(tagName);
        parentEl.appendChild(el);
        return el;
      }

      /**
       * System
       */
      class System {
        el;
        labelEl;
        starClass;

        static scoopableClass = [ 'O', 'B', 'A', 'F', 'G', 'K', 'M' ];

        constructor(parentEl, name, starClass) {
          this.el = createElement('li', parentEl);
          this.labelEl = createElement('span', this.el);
          this.labelEl.innerHTML = name;
          this.starClass = starClass;

          if (this.isScoopable()) {
            this.el.classList.add('scoopable');
          }
        }

        isScoopable() {
          return System.scoopableClass.includes(this.starClass);
        }

        getDomElementPosition() {
          return this.el.offsetLeft + this.el.offsetWidth - 5;
        }
      }

      /**
       * Init
       */
      let routeEl = createElement('ul', document.body);
      let systemList = {};
      let lastSystem;

      /**
       * Socket.io client
       */
      var socket = io();
    
      socket.on('route', route => {
        console.log('route:', route);

        routeEl.innerHTML = '';
        systemList = {};

        route.forEach(step => {
          const system = new System(routeEl, step.StarSystem, step.StarClass);
          systemList[step.StarSystem] = system;
          if (lastSystem == step.StarSystem) {
            system.el.classList.add('current');
          }
        });
      });
    
      socket.on('system', systemName => {
        console.log('system:', systemName);

        if (lastSystem && systemList[lastSystem]) {
          systemList[lastSystem].el.classList.remove('current')
        }

        if (systemName && systemList[systemName]) {
          const system = systemList[systemName];

          system.el.classList.remove('jumping');
          system.el.classList.add('current');

          routeEl.style.transform = `translateX(-${system.getDomElementPosition()}px)`;
        }

        lastSystem = systemName;
      });
      
      socket.on('jumping', system => {
        console.log('jumping:', system);
        
        if (lastSystem && systemList[lastSystem]) {
          systemList[lastSystem].el.classList.remove('current')
        }

        if (system && systemList[system]) {
          systemList[system].el.classList.add('jumping');
        }
      });
    </script>
  </body>
</html>