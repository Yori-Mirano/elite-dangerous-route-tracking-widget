<!DOCTYPE html>
<html>
  <head>
    <title>Elite Dangerous - Route Tracking Widget</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="/socket.io/socket.io.js"></script>

    <style>
      :root {
        --color-primary   : white;
        --color-secondary : #02a5ec;
        --color-off       : #666;

        scrollbar-width: thin;
        scrollbar-color: #222 #000;
      }

      ::-webkit-scrollbar             { height: 10px; }
      ::-webkit-scrollbar-thumb       { background: #222; }
      ::-webkit-scrollbar-thumb:hover { background: #555; }
      ::-webkit-scrollbar-track:hover { background: #222; }

      :root, body { height: 100%; }

      body {
        background-color: black;
        margin: 0;
        display: flex;
        overflow-y: hidden;
        font-family: Arial, sans-serif;
      }

      body::before,
      body::after {
        content: "";
        position: fixed;
        left: 0;
        background-image: linear-gradient(to right, black, transparent);
        height: 100%;
        width: 80px;
        z-index: 1;
      }

      body::after {
        left: auto;
        right: 0;
        transform: rotate(180deg);
      }
  
      ul {
        display: flex;
        margin: 0 auto;
        padding: 0 100px;
        list-style-type: none;
      }
  
      li {
        display: flex;
        align-items: center;
        position: relative;
      }

      li                      { --color: var(--color-secondary); }

      li.current              { --color: var(--color-primary); }
      li.current::before      { --color: var(--color-secondary); }
      li.current ~ li         { --color: var(--color-off); }

      li.jumping              { --color: var(--color-off); }
      li.jumping::before      { --color: var(--color-primary); }
      li.jumping ~ li         { --color: var(--color-off); }
  
      li::after {
        content: "";
        box-sizing: border-box;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        color: var(--color);
        border: 2px solid;
        transition-property: color, background-color;
        transition-duration: .5s;
      }

      li.scoopable::after {
        background-color: var(--color);
      }

      li.supercharge::after,
      li.white-dwarf::after {
        content: "Â¦";
        font-size: 22px;
        padding-bottom: 3px;
        justify-content: center;
        align-items: center;
        display: flex;
        width: 8px;
        height: 8px;
        margin: 1px;
        transform: rotate(45deg);
      }

      li.white-dwarf::after {
        width: 14px;
        height: 14px;
        margin: 0;
      }
      
      li.black-hole::after {
        border: none;
        width: 16px;
        height: 16px;
        background-image: radial-gradient(transparent 0%, var(--color) 32%, transparent 45%, transparent 50%, var(--color) 60%);
      }
  
      li + li::before {
        content: "";
        display: block;
        width: 35px;
        height: 2px;
        margin: 0 2px;
        background-color: var(--color);
        transition: background-color .5s;
      }
  
      li > span {
        position: absolute;
        right: 5px;
        transform: translate(50%, 20px);
        width: 12ch;
        font-size: 12px;
        text-align: center;
        line-height: 1;
        color: var(--color-off);
        transition: color .5s;
      }

      li.current > span {
        color: var(--color-primary);
      }
  
      li:nth-child(odd) > span {
        transform: translate(50%, -20px);
      }

      @keyframes pulse {
        from { background-position: 0; }
        to   { background-position: 100%; }
      }

      li.jumping::before {
        animation: pulse infinite 3s linear;
        background-image: linear-gradient(to right, transparent, white, transparent);
        background-color: transparent;
        background-size: 20%;
      }

      li.jumping > span {
        color: var(--color-primary);
      }
    </style>
  </head>
  
  <body>
    <script>
      /**
       * Helpers
       */
      function createElement(tagName, parentEl) {
        const el = document.createElement(tagName);
        parentEl.appendChild(el);
        return el;
      }

      function centerView() {
        if (lastSystem && systemList[lastSystem]) {
          const currentSystemElementPosition = systemList[lastSystem].getDomElementPosition();
          const newScrollPosition = currentSystemElementPosition - (document.body.offsetWidth / 2);
          window.scrollTo({left: newScrollPosition, behavior: "smooth"});
        }
      }

      /**
       * System
       */
      const SCOOPABLE_STAR_CLASSES = [ 'O', 'B', 'A', 'F', 'G', 'K', 'M' ];

      class System {
        el;
        labelEl;
        starClass;

        constructor(parentEl, name, starClass) {
          this.el = createElement('li', parentEl);
          this.labelEl = createElement('span', this.el);
          this.labelEl.innerHTML = name;
          this.starClass = starClass;

          if (this.isScoopable()) {
            this.el.classList.add('scoopable');
          }

          if (this.isSupercharge()) {
            this.el.classList.add('supercharge');
          }

          if (this.isWhiteDwarf()) {
            this.el.classList.add('white-dwarf');
          }

          if (this.isBlackHole()) {
            this.el.classList.add('black-hole');
          }
        }

        isScoopable() {
          return SCOOPABLE_STAR_CLASSES.includes(this.starClass);
        }

        isSupercharge() {
          return this.starClass.match(/^(N|D.*)$/) !== null;
        }

        isWhiteDwarf() {
          return this.starClass.match(/^D/) !== null;
        }

        isBlackHole() {
          return this.starClass === 'H';
        }

        getPointSize() {
          return parseInt(window.getComputedStyle(this.el,'::after').width, 10);
        }

        getDomElementPosition() {
          return this.el.offsetLeft + this.el.offsetWidth - (this.getPointSize() / 2);
        }
      }

      /**
       * Init
       */
      let routeEl = createElement('ul', document.body);
      let systemList = {};
      let lastSystem;

      window.addEventListener('resize', () => centerView() );

      /**
       * Socket.io client
       */
      var socket = io();
    
      socket.on('route', route => {
        console.log('route:', route);

        routeEl.innerHTML = '';
        systemList = {};

        route.forEach(step => {
          const system = new System(routeEl, step.StarSystem, step.StarClass);
          systemList[step.StarSystem] = system;
          if (lastSystem == step.StarSystem) {
            system.el.classList.add('current');
            setTimeout(() => centerView());
          }
        });
      });
    
      socket.on('system', systemName => {
        console.log('system:', systemName);

        if (systemName && systemList[systemName]) {
          const system = systemList[systemName];

          system.el.classList.remove('jumping');
          system.el.classList.add('current');
          setTimeout(() => centerView());
        }

        lastSystem = systemName;
      });
      
      socket.on('jumping', systemName => {
        console.log('jumping:', systemName);
        
        if (lastSystem && systemList[lastSystem]) {
          systemList[lastSystem].el.classList.remove('current')
        }

        if (systemName && systemList[systemName]) {
          systemList[systemName].el.classList.add('jumping');
          lastSystem = systemName; 
          setTimeout(() => centerView());
        }
      });
    </script>
  </body>
</html>